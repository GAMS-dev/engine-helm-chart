{{- $secretName := printf "%s-gams-secret" (include "common.names.fullname" .) -}}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName }}
{{- $brokerPassword := randAlphaNum 32 -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gams-engine.labels" . | nindent 4 }}
type: Opaque
stringData:
  GMS_RUNNER_DATABASE_ADMIN_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_DATABASE_ADMIN_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_DATABASE_BROKER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_DATABASE_BROKER_PWD") | b64dec }}{{ else }}{{ $brokerPassword }}{{ end }}
  GMS_RUNNER_DATABASE_WORKER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_DATABASE_WORKER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_DATABASE_CLEANER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_DATABASE_CLEANER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_DATABASE_SPWN_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_DATABASE_SPWN_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_DATABASE_K8S_CANCEL_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_DATABASE_K8S_CANCEL_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_DATABASE_DEPENDENCY_CHECK_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_DATABASE_DEPENDENCY_CHECK_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_DATABASE_EVENT_MANAGER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_DATABASE_EVENT_MANAGER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_DATABASE_K8S_JOB_WATCHER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_DATABASE_K8S_JOB_WATCHER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_PGBOUNCER_USERLIST: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_PGBOUNCER_USERLIST") | b64dec | quote }}{{ else }}{{ printf "'\"broker\" \"%s\"'" $brokerPassword }}{{ end }}
  GMS_RUNNER_MONGO_BROKER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_MONGO_BROKER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_MONGO_WORKER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_MONGO_WORKER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_MONGO_HYPERCUBE_APPENDER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_MONGO_HYPERCUBE_APPENDER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_MONGO_CLEANER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_MONGO_CLEANER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_MONGO_SPWN_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_MONGO_SPWN_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_MONGO_K8S_CANCEL_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_MONGO_K8S_CANCEL_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_MONGO_DEPENDENCY_CHECK_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_MONGO_DEPENDENCY_CHECK_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_MONGO_EVENT_MANAGER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_MONGO_EVENT_MANAGER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_MONGO_FORWARD_PROXY_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_MONGO_FORWARD_PROXY_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_MONGO_K8S_JOB_WATCHER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_MONGO_K8S_JOB_WATCHER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_FORWARD_PROXY_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_FORWARD_PROXY_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_FORWARD_PROXY_SECRET: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_FORWARD_PROXY_SECRET") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_FORWARD_PROXY_ENC_KEY: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_FORWARD_PROXY_ENC_KEY") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_RABBIT_BROKER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_RABBIT_BROKER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_RABBIT_WORKER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_RABBIT_WORKER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_RABBIT_HYPERCUBE_APPENDER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_RABBIT_HYPERCUBE_APPENDER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_RABBIT_CLEANER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_RABBIT_CLEANER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_RABBIT_HYPERCUBE_UNPACKER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_RABBIT_HYPERCUBE_UNPACKER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_RABBIT_MIGRATE_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_RABBIT_MIGRATE_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_RABBIT_SPWN_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_RABBIT_SPWN_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_RABBIT_K8S_CANCEL_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_RABBIT_K8S_CANCEL_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_RABBIT_DEPENDENCY_CHECK_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_RABBIT_DEPENDENCY_CHECK_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_RABBIT_EVENT_MANAGER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_RABBIT_EVENT_MANAGER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  GMS_RUNNER_RABBIT_K8S_JOB_WATCHER_PWD: {{ if $existingSecret }}{{ (index $existingSecret.data "GMS_RUNNER_RABBIT_K8S_JOB_WATCHER_PWD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  {{- if .Values.broker.monitoring.metricsEnabled }}
  PROMETHEUS_AUTH_USERNAME: "metrics"
  PROMETHEUS_AUTH_PASSWORD: {{ if $existingSecret }}{{ (index $existingSecret.data "PROMETHEUS_AUTH_PASSWORD") | b64dec }}{{ else }}{{ randAlphaNum 32 }}{{ end }}
  {{- end}}
